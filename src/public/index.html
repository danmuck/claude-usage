<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>claude.usage</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=IBM+Plex+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --font-display: 'JetBrains Mono', monospace;
    --font-body: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    --mono: 'DM Mono', 'SF Mono', 'Cascadia Code', monospace;

    --bg: #FAFAF7;
    --bg-card: #FFFFFF;
    --bg-surface: #F5F5F0;
    --text: #1A1A18;
    --text-secondary: #52524E;
    --text-tertiary: #8A8A86;
    --border: rgba(0,0,0,0.06);
    --border-strong: rgba(0,0,0,0.1);

    --accent: #D97706;
    --accent-light: #FBBF24;
    --accent-bg: rgba(217,119,6,0.08);

    --indigo: #6366F1;
    --violet: #8B5CF6;
    --teal: #14B8A6;
    --cyan: #06B6D4;
    --emerald: #10B981;
    --amber: #D97706;
    --orange: #F97316;
    --rose: #F43F5E;
    --blue: #3B82F6;

    --gradient-main: linear-gradient(135deg, #D97706, #F59E0B);
    --gradient-teal: linear-gradient(135deg, #14B8A6, #06B6D4);
    --gradient-warm: linear-gradient(135deg, #F59E0B, #F97316);
    --gradient-rose: linear-gradient(135deg, #F43F5E, #EC4899);

    --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.06);
    --shadow-lg: 0 8px 32px rgba(0,0,0,0.08);

    --radius: 16px;
    --radius-sm: 10px;
    --radius-xs: 6px;
    --navbar-h: 56px;
  }

  /* ---- DARK MODE ---- */
  [data-theme="dark"] {
    --bg: #111110;
    --bg-card: #1C1C1A;
    --bg-surface: #232320;
    --text: #EEEEE8;
    --text-secondary: #A3A39E;
    --text-tertiary: #6B6B66;
    --border: rgba(255,255,255,0.07);
    --border-strong: rgba(255,255,255,0.12);
    --accent-bg: rgba(217,119,6,0.15);
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.2);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.3);
    --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);
  }

  body {
    font-family: var(--font-body);
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
    overflow-x: hidden;
    transition: background-color 0.3s, color 0.3s;
  }

  /* ---- LOADING ---- */
  .loading {
    display: flex; align-items: center; justify-content: center;
    min-height: 100vh; flex-direction: column; gap: 20px;
  }
  .spinner {
    width: 36px; height: 36px;
    border: 3px solid var(--border); border-top-color: var(--accent);
    border-radius: 50%; animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { color: var(--text-secondary); font-size: 15px; font-weight: 500; }

  /* ---- NAVBAR ---- */
  .navbar {
    position: fixed; top: 0; left: 0; right: 0; height: var(--navbar-h);
    background: var(--bg-card);
    border-bottom: 1px solid var(--border);
    z-index: 1000; display: flex; align-items: center;
    padding: 0 24px; gap: 8px;
    transition: background-color 0.3s, border-color 0.3s;
  }
  [data-theme="dark"] .navbar {
    background: rgba(28,28,26,0.85);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  }
  .nav-brand {
    font-family: var(--font-display);
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
    margin-right: 24px;
    white-space: nowrap;
    user-select: none;
    letter-spacing: -0.3px;
  }
  .nav-tabs {
    display: flex; gap: 2px; position: relative;
    flex: 1; min-width: 0;
  }
  .nav-tab {
    background: none; border: none; cursor: pointer;
    font-family: var(--font-body);
    font-size: 13px; font-weight: 600;
    color: var(--text-tertiary);
    padding: 8px 14px; border-radius: 8px;
    transition: color 0.2s, background 0.2s;
    white-space: nowrap;
  }
  .nav-tab:hover { color: var(--text-secondary); background: var(--bg-surface); }
  .nav-tab.active { color: var(--accent); }
  .nav-indicator {
    position: absolute; bottom: -9px; height: 2px;
    background: var(--accent); border-radius: 2px;
    transition: left 0.3s ease, width 0.3s ease;
  }
  .nav-right {
    display: flex; align-items: center; gap: 10px; margin-left: auto;
  }
  .date-range {
    color: var(--text-tertiary); font-size: 12px; font-weight: 500;
    background: var(--bg-surface); padding: 5px 12px; border-radius: 20px;
    border: 1px solid var(--border); white-space: nowrap;
    transition: background-color 0.3s, border-color 0.3s;
  }
  .theme-toggle, .refresh-btn {
    background: var(--bg-surface); border: 1px solid var(--border);
    color: var(--text-secondary); cursor: pointer;
    border-radius: 8px; transition: all 0.2s;
    display: flex; align-items: center; justify-content: center;
  }
  .theme-toggle { width: 34px; height: 34px; font-size: 16px; padding: 0; }
  .theme-toggle:hover, .refresh-btn:hover {
    border-color: var(--accent); color: var(--accent);
  }
  .refresh-btn {
    padding: 6px 12px; gap: 5px; font-size: 12px; font-weight: 600;
    font-family: var(--font-body);
  }
  .refresh-btn svg { width: 13px; height: 13px; }

  /* ---- LAYOUT ---- */
  .container {
    max-width: 1200px; margin: 0 auto;
    padding: calc(var(--navbar-h) + 28px) 28px 60px;
    position: relative; z-index: 1;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate { animation: fadeUp 0.4s ease-out both; }
  .delay-1 { animation-delay: 0.05s; }
  .delay-2 { animation-delay: 0.1s; }
  .delay-3 { animation-delay: 0.15s; }
  .delay-4 { animation-delay: 0.2s; }
  .delay-5 { animation-delay: 0.25s; }

  /* ---- TAB PANELS ---- */
  .tab-panel { display: none; }
  .tab-panel.active { display: block; animation: fadeUp 0.35s ease-out both; }

  /* ---- STAT CARDS ---- */
  .stats-row {
    display: grid; grid-template-columns: repeat(4, 1fr);
    gap: 16px; margin-bottom: 32px;
  }
  @media (max-width: 780px) { .stats-row { grid-template-columns: repeat(2, 1fr); } }

  .stat-card {
    background: var(--bg-card); border-radius: var(--radius);
    padding: 24px; position: relative;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-sm);
    transition: box-shadow 0.2s, transform 0.2s, background-color 0.3s, border-color 0.3s;
  }
  .stat-card:hover { box-shadow: var(--shadow-md); }
  .stat-label {
    font-size: 11px; font-weight: 600; color: var(--text-tertiary);
    text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 10px;
  }
  .stat-value {
    font-family: var(--font-display);
    font-size: 32px; font-weight: 700; letter-spacing: -1px;
    line-height: 1; margin-bottom: 6px;
    color: var(--text);
  }
  .stat-sub { font-size: 12px; color: var(--text-tertiary); font-weight: 500; }

  /* Tooltips */
  .has-tooltip { position: relative; cursor: help; }
  .has-tooltip .tooltip {
    position: absolute; bottom: calc(100% + 10px); left: 50%;
    transform: translateX(-50%);
    background: var(--text); color: var(--bg);
    font-size: 12px; font-weight: 500; line-height: 1.5;
    padding: 10px 14px; border-radius: 10px;
    white-space: normal; width: max-content; max-width: 280px;
    pointer-events: none; opacity: 0;
    transition: opacity 0.15s, transform 0.15s;
    transform: translateX(-50%) translateY(4px);
    z-index: 100; box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    text-transform: none; letter-spacing: 0; text-align: left;
  }
  .has-tooltip .tooltip::after {
    content: ''; position: absolute; top: 100%; left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent; border-top-color: var(--text);
  }
  .has-tooltip:hover .tooltip { opacity: 1; transform: translateX(-50%) translateY(0); }
  .has-tooltip-below .tooltip { bottom: auto; top: calc(100% + 10px); }
  .has-tooltip-below .tooltip::after {
    top: auto; bottom: 100%;
    border-top-color: transparent; border-bottom-color: var(--text);
  }
  .help-icon {
    display: inline-flex; align-items: center; justify-content: center;
    width: 15px; height: 15px; border-radius: 50%;
    background: var(--border-strong); color: var(--text-tertiary);
    font-size: 10px; font-weight: 700; margin-left: 5px;
    vertical-align: middle; flex-shrink: 0;
  }

  /* Token explainer */
  .token-explainer {
    font-size: 13px; color: var(--text-tertiary); font-weight: 500;
    text-align: center; padding: 10px 20px; margin: -16px 0 28px;
    line-height: 1.5;
  }

  /* ---- SECTION HEADINGS ---- */
  .section-header {
    display: flex; align-items: center; gap: 10px; margin-bottom: 16px;
  }
  .section-icon {
    width: 28px; height: 28px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  }
  .section-icon svg { width: 16px; height: 16px; }
  .section-title { font-size: 16px; font-weight: 700; letter-spacing: -0.3px; }

  /* ---- INSIGHTS ---- */
  .insights-section { margin-bottom: 32px; }
  .insight-card {
    background: var(--bg-card); border-radius: var(--radius-sm);
    padding: 14px 20px; margin-bottom: 8px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-sm);
    cursor: pointer; transition: box-shadow 0.2s, background-color 0.3s, border-color 0.3s;
  }
  .insight-card:hover { box-shadow: var(--shadow-md); }
  .insight-top { display: flex; align-items: center; gap: 12px; }
  .insight-arrow {
    margin-left: auto; flex-shrink: 0;
    width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;
    color: var(--text-tertiary); transition: transform 0.25s ease;
  }
  .insight-card.expanded .insight-arrow { transform: rotate(180deg); }
  .insight-indicator {
    width: 28px; height: 28px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; font-size: 14px;
  }
  .insight-card.warning .insight-indicator { background: linear-gradient(135deg, #FEF3C7, #FDE68A); }
  .insight-card.info .insight-indicator { background: linear-gradient(135deg, #E0E7FF, #C7D2FE); }
  .insight-card.neutral .insight-indicator { background: linear-gradient(135deg, #F1F5F9, #E2E8F0); }
  [data-theme="dark"] .insight-card.warning .insight-indicator { background: linear-gradient(135deg, #78350F, #92400E); }
  [data-theme="dark"] .insight-card.info .insight-indicator { background: linear-gradient(135deg, #312E81, #3730A3); }
  [data-theme="dark"] .insight-card.neutral .insight-indicator { background: linear-gradient(135deg, #27272A, #3F3F46); }
  .insight-title { font-size: 14px; font-weight: 700; line-height: 1.4; }
  .insight-oneliner { font-size: 13px; color: var(--text-secondary); margin-left: auto; white-space: nowrap; font-weight: 500; }
  .insight-expand { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
  .insight-card.expanded .insight-expand { max-height: 300px; }
  .insight-detail {
    font-size: 13px; color: var(--text-secondary); line-height: 1.65;
    padding: 12px 0 4px 40px;
    border-top: 1px solid var(--border); margin-top: 12px;
  }
  .insight-action-tip {
    font-size: 13px; line-height: 1.6;
    padding: 8px 0 0 40px; color: var(--accent); font-weight: 600;
  }

  /* ---- CHARTS ---- */
  .charts-grid {
    display: grid; grid-template-columns: 5fr 2fr;
    gap: 16px; margin-bottom: 32px;
  }
  @media (max-width: 800px) { .charts-grid { grid-template-columns: 1fr; } }

  .chart-card {
    background: var(--bg-card); border-radius: var(--radius);
    padding: 24px; border: 1px solid var(--border);
    box-shadow: var(--shadow-sm);
    transition: background-color 0.3s, border-color 0.3s;
  }
  .chart-card h3 {
    font-size: 13px; font-weight: 700; color: var(--text-tertiary);
    text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 20px;
  }
  canvas { display: block; }
  .legend {
    display: flex; gap: 20px; margin-top: 16px;
    font-size: 12px; font-weight: 500; color: var(--text-secondary);
  }
  .legend-item { display: flex; align-items: center; gap: 7px; }
  .legend-dot { width: 10px; height: 10px; border-radius: 4px; flex-shrink: 0; }

  /* ---- TOP PROMPTS ---- */
  .top-prompts { margin-bottom: 32px; }
  .prompts-card {
    background: var(--bg-card); border-radius: var(--radius);
    border: 1px solid var(--border); box-shadow: var(--shadow-sm);
    overflow: hidden; transition: background-color 0.3s, border-color 0.3s;
  }
  .prompt-row {
    display: grid; grid-template-columns: 36px 1fr auto;
    gap: 14px; padding: 16px 24px; align-items: start;
    border-bottom: 1px solid var(--border);
    cursor: pointer; transition: background 0.15s;
  }
  .prompt-row:last-child { border-bottom: none; }
  .prompt-row:hover { background: var(--bg-surface); }
  .prompt-rank {
    width: 28px; height: 28px; border-radius: 8px;
    background: var(--bg-surface); display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 700; color: var(--text-secondary);
  }
  .prompt-row:nth-child(1) .prompt-rank { background: var(--gradient-main); color: white; }
  .prompt-row:nth-child(2) .prompt-rank { background: var(--gradient-teal); color: white; }
  .prompt-row:nth-child(3) .prompt-rank { background: var(--gradient-warm); color: white; }
  .prompt-text {
    font-size: 14px; font-weight: 500; line-height: 1.5;
    display: -webkit-box; -webkit-line-clamp: 2;
    -webkit-box-orient: vertical; overflow: hidden;
  }
  .prompt-meta { font-size: 12px; color: var(--text-tertiary); margin-top: 4px; font-weight: 500; }
  .token-bar-wrap {
    display: flex; gap: 1px; height: 4px; margin-top: 8px;
    border-radius: 4px; overflow: hidden;
  }
  .token-bar-in { background: var(--accent); height: 100%; border-radius: 4px 0 0 4px; }
  .token-bar-out { background: var(--teal); height: 100%; border-radius: 0 4px 4px 0; }
  .prompt-tokens { text-align: right; white-space: nowrap; padding-top: 2px; }
  .prompt-tokens .value {
    font-size: 16px; font-weight: 700; font-family: var(--mono);
    letter-spacing: -0.5px;
  }
  .prompt-tokens .sub { font-size: 11px; color: var(--text-tertiary); font-weight: 500; margin-top: 2px; }

  /* ---- PROJECTS ---- */
  .projects-section { margin-bottom: 32px; }
  .proj-chevron {
    width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center;
    color: var(--text-tertiary); transition: transform 0.25s ease; flex-shrink: 0;
  }
  .proj-row { cursor: pointer; }
  .proj-row:hover td { background: var(--bg-surface); }
  .proj-row.expanded .proj-chevron { transform: rotate(90deg); }
  .proj-drawer td { padding: 0; border-bottom: 1px solid var(--border); }
  .proj-drawer-inner { max-height: 0; overflow: hidden; transition: max-height 0.35s ease; background: var(--bg-surface); }
  .proj-drawer.open .proj-drawer-inner { max-height: 600px; }
  .proj-drawer-content { padding: 12px 16px 16px; }
  .drawer-prompt-list { display: flex; flex-direction: column; gap: 8px; }
  .drawer-prompt-row {
    display: grid; grid-template-columns: 24px 1fr auto;
    gap: 10px; padding: 10px 14px; align-items: start;
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px;
    cursor: pointer; transition: box-shadow 0.15s, background-color 0.3s;
  }
  .drawer-prompt-row:hover { box-shadow: var(--shadow-md); }
  .drawer-rank {
    width: 20px; height: 20px; border-radius: 6px;
    background: var(--bg-surface); display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; color: var(--text-secondary); flex-shrink: 0;
  }
  .drawer-prompt-text {
    font-size: 13px; font-weight: 500; line-height: 1.5;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    word-break: break-word;
  }
  .drawer-prompt-meta { display: flex; flex-wrap: wrap; gap: 4px; align-items: center; margin-top: 5px; }
  .tool-chip {
    background: var(--bg-surface); border: 1px solid var(--border-strong);
    padding: 1px 7px; border-radius: 6px; font-size: 10px; font-weight: 600;
    color: var(--text-secondary); white-space: nowrap;
    transition: background-color 0.3s, border-color 0.3s;
  }
  .drawer-tokens { text-align: right; white-space: nowrap; }
  .drawer-tokens .value { font-family: var(--mono); font-size: 14px; font-weight: 700; }
  .drawer-tokens .sub { font-size: 11px; color: var(--text-tertiary); font-weight: 500; margin-top: 2px; }
  .drawer-empty { text-align: center; padding: 20px; color: var(--text-tertiary); font-size: 13px; font-weight: 500; }

  /* ---- SESSIONS ---- */
  .sessions-section { margin-bottom: 40px; }
  .sessions-toolbar {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 14px; gap: 12px; flex-wrap: wrap;
  }
  .session-search {
    background: var(--bg-card); border: 1px solid var(--border);
    color: var(--text); padding: 9px 16px; border-radius: 10px;
    font-size: 14px; font-weight: 500; width: 300px; outline: none;
    font-family: var(--font-body); transition: all 0.2s;
  }
  .session-search::placeholder { color: var(--text-tertiary); }
  .session-search:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(217,119,6,0.1); }
  .session-count { color: var(--text-tertiary); font-size: 13px; font-weight: 600; }

  .sessions-card {
    background: var(--bg-card); border-radius: var(--radius);
    border: 1px solid var(--border); box-shadow: var(--shadow-sm);
    overflow: hidden; transition: background-color 0.3s, border-color 0.3s;
  }
  .sessions-table { width: 100%; border-collapse: collapse; font-size: 14px; }
  .sessions-table th {
    text-align: left; padding: 12px 16px;
    font-size: 11px; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.6px; color: var(--text-tertiary);
    border-bottom: 1px solid var(--border);
    cursor: pointer; user-select: none; white-space: nowrap;
    background: var(--bg-surface);
    transition: background-color 0.3s;
  }
  .sessions-table th:hover { color: var(--text-secondary); }
  .sessions-table th.sorted { color: var(--accent); }
  .sessions-table td {
    padding: 12px 16px; border-bottom: 1px solid var(--border); vertical-align: middle;
    color: var(--text-secondary);
  }
  .sessions-table tbody tr { cursor: pointer; transition: background 0.1s; }
  .sessions-table tbody tr:hover td { background: var(--bg-surface); }
  .sessions-table tbody tr:last-child td { border-bottom: none; }
  .sessions-table tbody tr.recent-session td { background: var(--accent-bg); }
  .sessions-table tbody tr.recent-session td:first-child {
    border-left: 3px solid var(--accent); padding-left: 13px;
  }
  .sessions-table tbody tr.recent-session:hover td { background: rgba(217,119,6,0.14); }
  .recent-badge {
    display: inline-block; font-size: 9px; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.5px; color: var(--accent); background: rgba(217,119,6,0.12);
    padding: 2px 6px; border-radius: 4px; margin-left: 6px; vertical-align: middle;
  }
  .prompt-preview {
    max-width: 340px; overflow: hidden; text-overflow: ellipsis;
    white-space: nowrap; font-weight: 500;
  }
  .token-num {
    font-family: var(--mono); font-size: 13px; font-weight: 600;
    text-align: right; white-space: nowrap; letter-spacing: -0.3px;
  }
  .model-badge {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 3px 10px; border-radius: 20px;
    font-size: 12px; font-weight: 600;
    transition: box-shadow 0.15s;
  }
  .model-badge:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
  .model-opus { background: #EEF2FF; color: #3730A3; }
  .model-sonnet { background: #ECFDF5; color: #047857; }
  .model-haiku { background: #FFF7ED; color: #C2410C; }
  .model-unknown { background: #F1F5F9; color: #475569; }
  [data-theme="dark"] .model-opus { background: #312E81; color: #C7D2FE; }
  [data-theme="dark"] .model-sonnet { background: #064E3B; color: #A7F3D0; }
  [data-theme="dark"] .model-haiku { background: #7C2D12; color: #FED7AA; }
  [data-theme="dark"] .model-unknown { background: #27272A; color: #A1A1AA; }
  .model-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
  .model-opus .model-dot { background: #4F46E5; }
  .model-sonnet .model-dot { background: #10B981; }
  .model-haiku .model-dot { background: #F97316; }
  [data-theme="dark"] .model-opus .model-dot { background: #818CF8; }
  [data-theme="dark"] .model-sonnet .model-dot { background: #34D399; }
  [data-theme="dark"] .model-haiku .model-dot { background: #FB923C; }
  .model-pills {
    list-style: none; padding: 0; margin: 5px 0 0;
    display: flex; flex-wrap: wrap; gap: 4px;
  }
  .model-pills li { display: flex; }
  .model-pills .model-badge { padding: 2px 8px; font-size: 11px; border-radius: 10px; }
  .sr-only {
    position: absolute; width: 1px; height: 1px; padding: 0;
    margin: -1px; overflow: hidden; clip: rect(0,0,0,0);
    white-space: nowrap; border-width: 0;
  }
  .token-detail {
    display: inline-flex; align-items: center; gap: 2px;
    font-size: 10px; font-weight: 600; opacity: 0.9;
  }
  .proj-name {
    font-weight: 600; font-size: 13px;
    font-family: var(--mono); letter-spacing: -0.2px; color: var(--text);
  }
  .proj-row.recent-project td { background: var(--accent-bg); }
  .proj-row.recent-project td:first-child { border-left: 3px solid var(--accent); }
  .proj-row.recent-project:hover td { background: rgba(217,119,6,0.14); }
  .date-cell { white-space: nowrap; color: var(--text-secondary); font-weight: 500; }
  .project-tag {
    font-size: 11px; color: var(--text-tertiary); display: block;
    margin-top: 1px; font-weight: 500;
    max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }

  /* ---- DRILLDOWN OVERLAY ---- */
  .drilldown-overlay {
    position: fixed; inset: 0; z-index: 2000;
    background: rgba(0,0,0,0.4);
    backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
    display: none; align-items: center; justify-content: center;
    padding: 24px;
    opacity: 0; transition: opacity 0.2s;
  }
  .drilldown-overlay.open { display: flex; opacity: 1; }
  .drilldown {
    background: var(--bg-card); border-radius: var(--radius);
    padding: 28px; width: 100%; max-width: 720px;
    max-height: calc(100vh - 48px); overflow-y: auto;
    border: 1px solid var(--border); box-shadow: var(--shadow-lg);
    animation: fadeUp 0.25s ease-out;
    transition: background-color 0.3s, border-color 0.3s;
  }
  .drilldown-header {
    display: flex; align-items: flex-start; justify-content: space-between;
    margin-bottom: 24px; gap: 16px;
  }
  .drilldown-title { font-size: 16px; font-weight: 700; line-height: 1.4; }
  .drilldown-meta { font-size: 13px; color: var(--text-tertiary); margin-top: 4px; font-weight: 500; }
  .drilldown-close {
    background: var(--bg-surface); border: none; color: var(--text-secondary);
    width: 32px; height: 32px; border-radius: 8px; cursor: pointer;
    font-size: 18px; display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: all 0.15s;
  }
  .drilldown-close:hover { background: var(--accent-bg); color: var(--accent); }
  .query-list { display: flex; flex-direction: column; gap: 8px; }
  .query-item {
    display: grid; grid-template-columns: 36px 1fr auto;
    gap: 14px; padding: 14px 16px; border-radius: var(--radius-sm);
    background: var(--bg-surface); align-items: start;
    transition: background 0.1s;
  }
  .query-item:hover { background: var(--accent-bg); }
  .query-num {
    width: 28px; height: 28px; border-radius: 8px; background: var(--bg-card);
    border: 1px solid var(--border);
    font-size: 12px; font-weight: 700; color: var(--text-tertiary);
    display: flex; align-items: center; justify-content: center;
  }
  .query-prompt { font-size: 14px; font-weight: 500; line-height: 1.5; word-break: break-word; }
  .query-prompt.no-prompt { color: var(--text-tertiary); font-style: italic; font-weight: 400; }
  .query-tokens-col { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; white-space: nowrap; }
  .query-tokens-col .total { font-family: var(--mono); font-size: 14px; font-weight: 700; }
  .query-tokens-col .detail { font-size: 12px; color: var(--text-tertiary); font-weight: 500; }

  /* ---- FOOTER ---- */
  .footer {
    text-align: center; padding: 24px;
    color: var(--text-tertiary); font-size: 13px; font-weight: 500;
  }
  .footer a { color: var(--accent); text-decoration: none; font-weight: 600; }
  .footer a:hover { text-decoration: underline; }

  /* Privacy notice */
  .privacy-notice {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    font-size: 13px; font-weight: 500; color: var(--text-secondary);
    background: var(--accent-bg); border: 1px solid rgba(217,119,6,0.15);
    padding: 8px 16px; border-radius: 10px; margin-bottom: 20px;
    transition: background-color 0.3s, border-color 0.3s, color 0.3s;
  }

  /* ---- STORAGE ---- */
  .storage-section { margin-bottom: 40px; }
  .storage-headline {
    font-family: var(--font-display); font-size: 48px; font-weight: 700;
    letter-spacing: -2px; margin-bottom: 4px;
  }
  .storage-sub { font-size: 14px; color: var(--text-tertiary); font-weight: 500; margin-bottom: 28px; }
  .storage-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 28px; }
  @media (max-width: 780px) { .storage-grid { grid-template-columns: 1fr; } }
  .storage-bar-card {
    background: var(--bg-card); border-radius: var(--radius); padding: 24px;
    border: 1px solid var(--border); box-shadow: var(--shadow-sm);
    transition: background-color 0.3s, border-color 0.3s;
  }
  .storage-bar-card h3 {
    font-size: 13px; font-weight: 700; color: var(--text-tertiary);
    text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px;
  }
  .storage-bar-row {
    display: flex; align-items: center; gap: 12px; margin-bottom: 10px;
  }
  .storage-bar-label {
    font-family: var(--mono); font-size: 13px; font-weight: 500;
    min-width: 120px; color: var(--text);
  }
  .storage-bar-track {
    flex: 1; height: 8px; background: var(--bg-surface);
    border-radius: 4px; overflow: hidden;
  }
  .storage-bar-fill {
    height: 100%; border-radius: 4px;
    transition: width 0.5s ease;
  }
  .storage-bar-size {
    font-family: var(--mono); font-size: 12px; font-weight: 600;
    color: var(--text-secondary); min-width: 70px; text-align: right;
  }
  .storage-treemap {
    display: grid; gap: 4px; grid-auto-rows: minmax(60px, auto);
    margin-bottom: 28px;
  }
  .treemap-cell {
    border-radius: var(--radius-sm); padding: 14px;
    display: flex; flex-direction: column; justify-content: flex-end;
    min-height: 60px; position: relative; overflow: hidden;
  }
  .treemap-cell .tm-name {
    font-family: var(--mono); font-size: 13px; font-weight: 600; color: white;
    text-shadow: 0 1px 3px rgba(0,0,0,0.3);
  }
  .treemap-cell .tm-size {
    font-family: var(--mono); font-size: 11px; color: rgba(255,255,255,0.8);
  }

  /* ---- RESPONSIVE ---- */
  @media (max-width: 700px) {
    .nav-tabs { overflow-x: auto; }
    .date-range { display: none; }
    .drilldown-overlay { padding: 0; align-items: flex-end; }
    .drilldown { border-radius: var(--radius) var(--radius) 0 0; max-height: 85vh; }
  }
</style>
</head>
<body>

<div id="loading" class="loading">
  <div class="spinner"></div>
  <div class="loading-text">Loading claude.usage...</div>
</div>

<!-- Navbar -->
<nav class="navbar" id="navbar" style="display:none">
  <div class="nav-brand">claude.usage</div>
  <div class="nav-tabs" id="navTabs">
    <button class="nav-tab active" data-tab="overview" onclick="switchTab('overview')">Overview</button>
    <button class="nav-tab" data-tab="insights" onclick="switchTab('insights')">Insights</button>
    <button class="nav-tab" data-tab="projects" onclick="switchTab('projects')">Projects</button>
    <button class="nav-tab" data-tab="prompts" onclick="switchTab('prompts')">Expensive Prompts</button>
    <button class="nav-tab" data-tab="sessions" onclick="switchTab('sessions')">Sessions</button>
    <button class="nav-tab" data-tab="storage" onclick="switchTab('storage')">Storage</button>
    <div class="nav-indicator" id="navIndicator"></div>
  </div>
  <div class="nav-right">
    <span id="dateRange" class="date-range"></span>
    <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle dark mode" aria-label="Toggle dark mode"></button>
    <button class="refresh-btn" onclick="refreshData()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
      Refresh
    </button>
  </div>
</nav>

<div id="app" class="container" style="display:none">

  <!-- OVERVIEW TAB -->
  <div class="tab-panel active" id="tab-overview">
    <div class="privacy-notice animate">
      &#128274; All data stays on your machine. Nothing is sent anywhere.
    </div>

    <div class="stats-row" id="statsRow"></div>
    <div id="tokenExplainer" class="token-explainer animate delay-2">
      Tokens are how AI measures text -- roughly 1 token = 1 word. Hover over any label with a <span style="display:inline-flex;align-items:center;justify-content:center;width:15px;height:15px;border-radius:50%;background:var(--border-strong);font-size:10px;font-weight:700;vertical-align:middle;">?</span> for an explanation.
    </div>

    <div class="charts-grid animate delay-3">
      <div class="chart-card">
        <h3 class="has-tooltip has-tooltip-below" style="display:inline-block">Tokens per Day<div class="tooltip">How many tokens you used each day. The amber portion is what Claude read, the teal is what Claude wrote.</div></h3>
        <canvas id="dailyChart"></canvas>
        <div class="legend">
          <div class="legend-item"><div class="legend-dot" style="background:var(--accent)"></div> Read by Claude</div>
          <div class="legend-item"><div class="legend-dot" style="background:var(--teal)"></div> Written by Claude</div>
        </div>
      </div>
      <div class="chart-card">
        <h3>By Model</h3>
        <canvas id="modelChart"></canvas>
        <div id="modelLegend" class="legend" style="flex-direction:column; gap:12px; margin-top:20px;"></div>
      </div>
    </div>
  </div>

  <!-- INSIGHTS TAB -->
  <div class="tab-panel" id="tab-insights">
    <div id="insightsSection" class="insights-section">
      <div class="section-header animate">
        <div class="section-icon" style="background:linear-gradient(135deg,#FEF3C7,#FDE68A)">
          <svg viewBox="0 0 24 24" fill="none" stroke="#D97706" stroke-width="2.5" stroke-linecap="round"><path d="M12 2a7 7 0 0 1 4 12.75V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.25A7 7 0 0 1 12 2z"/><path d="M9 21h6"/></svg>
        </div>
        <div class="section-title">Insights</div>
      </div>
      <div id="insightsList"></div>
    </div>
  </div>

  <!-- PROJECTS TAB -->
  <div class="tab-panel" id="tab-projects">
    <div class="projects-section animate">
      <div class="section-header">
        <div class="section-icon" style="background:linear-gradient(135deg,#EDE9FE,#DDD6FE)">
          <svg viewBox="0 0 24 24" fill="none" stroke="#7C3AED" stroke-width="2.5" stroke-linecap="round"><path d="M3 7l9-4 9 4v10l-9 4-9-4z"/><path d="M12 3v18"/><path d="M3 7l9 4 9-4"/></svg>
        </div>
        <div class="section-title">Projects</div>
        <span id="projectsCount" style="font-size:13px;color:var(--text-tertiary);font-weight:600;margin-left:auto"></span>
      </div>
      <div class="sessions-card">
        <table class="sessions-table">
          <thead>
            <tr>
              <th>Project</th>
              <th style="text-align:right">Total Tokens</th>
              <th style="text-align:right">Sessions</th>
              <th style="text-align:right">Queries</th>
            </tr>
          </thead>
          <tbody id="projectsBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- EXPENSIVE PROMPTS TAB -->
  <div class="tab-panel" id="tab-prompts">
    <div class="top-prompts animate">
      <div class="section-header">
        <div class="section-icon" style="background:linear-gradient(135deg,#E0E7FF,#C7D2FE)">
          <svg viewBox="0 0 24 24" fill="none" stroke="#6366F1" stroke-width="2.5" stroke-linecap="round"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
        </div>
        <div class="section-title has-tooltip has-tooltip-below" style="display:inline-flex">Most Expensive Prompts<div class="tooltip">Your top 20 individual messages ranked by how many tokens they used.</div></div>
      </div>
      <div class="prompts-card" id="topPromptsList"></div>
    </div>
  </div>

  <!-- STORAGE TAB -->
  <div class="tab-panel" id="tab-storage">
    <div class="storage-section animate">
      <div class="section-header">
        <div class="section-icon" style="background:linear-gradient(135deg,#FEF3C7,#FDE68A)">
          <svg viewBox="0 0 24 24" fill="none" stroke="#D97706" stroke-width="2.5" stroke-linecap="round"><path d="M4 7V4a2 2 0 0 1 2-2h8.5L20 7.5V20a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-3"/><path d="M14 2v6h6"/><path d="M2 15h10"/><path d="M5 12l-3 3 3 3"/></svg>
        </div>
        <div class="section-title">Storage</div>
      </div>
      <div id="storageContent"></div>
    </div>
  </div>

  <!-- SESSIONS TAB -->
  <div class="tab-panel" id="tab-sessions">
    <div class="sessions-section animate">
      <div class="section-header">
        <div class="section-icon" style="background:linear-gradient(135deg,#ECFDF5,#D1FAE5)">
          <svg viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2.5" stroke-linecap="round"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/></svg>
        </div>
        <div class="section-title">All Sessions</div>
      </div>
      <div class="sessions-toolbar">
        <input type="text" class="session-search" id="searchInput" placeholder="Search prompts, models, projects...">
        <span id="sessionCount" class="session-count"></span>
      </div>
      <div class="sessions-card">
        <table class="sessions-table">
          <thead>
            <tr>
              <th data-sort="date">Date</th>
              <th data-sort="project">Project</th>
              <th data-sort="model">Model</th>
              <th data-sort="queries" style="text-align:right">Messages</th>
              <th data-sort="total" style="text-align:right" class="sorted">Total tokens</th>
              <th data-sort="input" style="text-align:right">Read</th>
              <th data-sort="output" style="text-align:right">Written</th>
            </tr>
          </thead>
          <tbody id="sessionsBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="footer">
    Forked from <a href="https://github.com/AniketParihar/claude-spend" target="_blank" rel="noopener noreferrer">claude-spend</a> by <a href="https://www.linkedin.com/in/aniketparihar/" target="_blank" rel="noopener noreferrer">Aniket</a> &mdash; thank you! &middot; Built with <a href="https://claude.ai/code" target="_blank" rel="noopener noreferrer">Claude Code</a>
  </div>
</div>

<!-- Drilldown Modal Overlay -->
<div class="drilldown-overlay" id="drilldownOverlay" onclick="if(event.target===this)closeDrilldown()">
  <div class="drilldown" id="drilldown">
    <div class="drilldown-header">
      <div>
        <div id="drilldownTitle" class="drilldown-title"></div>
        <div id="drilldownMeta" class="drilldown-meta"></div>
      </div>
      <button class="drilldown-close" onclick="closeDrilldown()">&times;</button>
    </div>
    <div id="queryList" class="query-list"></div>
  </div>
</div>

<script>
let DATA = null;
let currentSort = { key: 'date', dir: 'desc' };
let searchQuery = '';
let currentTab = 'overview';

function fmt(n) {
  if (n >= 1_000_000) return (n / 1_000_000).toFixed(1) + 'M';
  if (n >= 10_000) return (n / 1_000).toFixed(0) + 'K';
  if (n >= 1_000) return (n / 1_000).toFixed(1) + 'K';
  return n.toLocaleString();
}
function fmtFull(n) { return n.toLocaleString(); }

function modelClass(m) {
  if (m.includes('opus')) return 'model-opus';
  if (m.includes('sonnet')) return 'model-sonnet';
  if (m.includes('haiku')) return 'model-haiku';
  return 'model-unknown';
}
function modelShort(m) {
  let match = m.match(/^claude-(opus|sonnet|haiku)-(\d+)-(\d+)/i);
  if (match) {
    const name = match[1].charAt(0).toUpperCase() + match[1].slice(1);
    return name + ' ' + match[2] + '.' + match[3];
  }
  match = m.match(/^claude-(\d+)-(\d+)-(opus|sonnet|haiku)/i);
  if (match) {
    const name = match[3].charAt(0).toUpperCase() + match[3].slice(1);
    return name + ' ' + match[1] + '.' + match[2];
  }
  match = m.match(/^claude-(\d+)-(opus|sonnet|haiku)/i);
  if (match) {
    const name = match[2].charAt(0).toUpperCase() + match[2].slice(1);
    return name + ' ' + match[1];
  }
  if (m.includes('opus')) return 'Opus';
  if (m.includes('sonnet')) return 'Sonnet';
  if (m.includes('haiku')) return 'Haiku';
  return m;
}
function projectShort(p, projectPath) {
  const fullPath = projectPath || p;
  let s = fullPath.replace(/^\//, '');
  const known = /^(?:Users|home|user)\/[^/]+\/|^(?:GitHub|GitLab|git|Projects|projects|workspace|Workspace|Desktop|Documents|Library\/Mobile Documents\/[^/]+\/[^/]+\/[^/]+\/|source|src|dev|Dev|code|Code|repos|Repos|local)\//;
  let prev;
  do { prev = s; s = s.replace(known, ''); } while (s !== prev && s.length > 0);
  return s || fullPath.split('/').pop() || p;
}
function projectFull(p, projectPath) {
  return projectPath || p;
}
function escapeHtml(s) {
  const d = document.createElement('div'); d.textContent = s; return d.innerHTML;
}
function formatDate(d) {
  if (!d) return '';
  const parts = d.split('-');
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return months[parseInt(parts[1])-1] + ' ' + parseInt(parts[2]);
}

/* ---- THEME SYSTEM ---- */
function chartColors() {
  const dark = document.documentElement.getAttribute('data-theme') === 'dark';
  return {
    grid: dark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.04)',
    gridText: dark ? '#6B6B66' : '#94A3B8',
    barIn1: dark ? '#F59E0B' : '#D97706',
    barIn2: dark ? '#FBBF24' : '#F59E0B',
    barOut1: dark ? '#2DD4BF' : '#14B8A6',
    barOut2: dark ? '#5EEAD4' : '#2DD4BF',
    donutGap: dark ? '#1C1C1A' : '#FFFFFF',
    centerText: dark ? '#EEEEE8' : '#1A1A18',
    centerSub: dark ? '#6B6B66' : '#94A3B8',
  };
}

function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem('claude-usage-theme', theme);
  var btn = document.getElementById('themeToggle');
  btn.textContent = theme === 'dark' ? '\u2600\uFE0F' : '\uD83C\uDF19';
  if (DATA) { renderDailyChart(); renderModelChart(); }
}
function toggleTheme() {
  var current = document.documentElement.getAttribute('data-theme');
  applyTheme(current === 'dark' ? 'light' : 'dark');
}
// Init theme
(function() {
  var saved = localStorage.getItem('claude-usage-theme');
  var theme = saved || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  document.documentElement.setAttribute('data-theme', theme);
  document.getElementById('themeToggle').textContent = theme === 'dark' ? '\u2600\uFE0F' : '\uD83C\uDF19';
})();

/* ---- TAB SYSTEM ---- */
function switchTab(tabName) {
  currentTab = tabName;
  var panels = document.querySelectorAll('.tab-panel');
  for (var i = 0; i < panels.length; i++) panels[i].classList.remove('active');
  var tabs = document.querySelectorAll('.nav-tab');
  for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
  var panel = document.getElementById('tab-' + tabName);
  var tab = document.querySelector('.nav-tab[data-tab="' + tabName + '"]');
  if (panel) panel.classList.add('active');
  if (tab) tab.classList.add('active');
  updateTabIndicator();
  // Redraw charts when switching to overview (canvas needs visible container)
  if (tabName === 'overview' && DATA) {
    setTimeout(function() { renderDailyChart(); renderModelChart(); }, 10);
  }
}
function updateTabIndicator() {
  var activeTab = document.querySelector('.nav-tab.active');
  var indicator = document.getElementById('navIndicator');
  if (!activeTab || !indicator) return;
  var container = document.getElementById('navTabs');
  var containerRect = container.getBoundingClientRect();
  var tabRect = activeTab.getBoundingClientRect();
  indicator.style.left = (tabRect.left - containerRect.left) + 'px';
  indicator.style.width = tabRect.width + 'px';
}

/* ---- DATA ---- */
async function fetchData() {
  var res = await fetch('/api/data');
  DATA = await res.json();
  render();
}
async function refreshData() {
  document.getElementById('loading').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
  document.getElementById('navbar').style.display = 'none';
  await fetch('/api/refresh');
  await fetchData();
}

function render() {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  document.getElementById('navbar').style.display = 'flex';
  renderStats();
  renderInsights();
  renderDailyChart();
  renderModelChart();
  renderProjectBreakdown();
  renderTopPrompts();
  renderSessions();
  renderStorage();
  setTimeout(updateTabIndicator, 0);
}

// Stats
function renderStats() {
  var t = DATA.totals;
  var range = t.dateRange ? formatDate(t.dateRange.from) + ' \u2013 ' + formatDate(t.dateRange.to) : '';
  document.getElementById('dateRange').textContent = range;

  var cards = [
    { label: 'Total Usage', value: fmt(t.totalTokens), sub: fmt(t.totalInputTokens) + ' read + ' + fmt(t.totalOutputTokens) + ' written',
      tip: 'The total number of tokens used across all your conversations.' },
    { label: 'Conversations', value: fmtFull(t.totalSessions), sub: '~' + fmt(t.avgTokensPerSession) + ' tokens avg',
      tip: 'Each time you start Claude Code, that counts as one conversation.' },
    { label: 'Messages Sent', value: fmtFull(t.totalQueries), sub: '~' + fmt(t.avgTokensPerQuery) + ' tokens avg',
      tip: 'Every message you sent, including automatic tool calls.' },
    { label: 'Claude Wrote', value: fmt(t.totalOutputTokens), sub: ((t.totalOutputTokens / Math.max(t.totalTokens, 1)) * 100).toFixed(1) + '% of total',
      tip: 'Tokens Claude spent writing responses. Usually a tiny fraction of total.' },
  ];

  var html = '';
  for (var i = 0; i < cards.length; i++) {
    var c = cards[i];
    html += '<div class="stat-card animate delay-' + (i + 1) + '">' +
      '<div class="stat-label has-tooltip">' + c.label + '<span class="help-icon">?</span><div class="tooltip">' + c.tip + '</div></div>' +
      '<div class="stat-value">' + c.value + '</div>' +
      '<div class="stat-sub">' + c.sub + '</div>' +
      '</div>';
  }
  document.getElementById('statsRow').innerHTML = html;
}

// Insights
function renderInsights() {
  var insights = DATA.insights || [];
  if (!insights.length) {
    document.getElementById('insightsList').innerHTML = '<div class="drawer-empty">No insights yet. Use Claude Code more to generate insights.</div>';
    return;
  }

  var emojis = { warning: '\u26A0\uFE0F', info: '\uD83D\uDCA1', neutral: '\uD83D\uDCC5' };
  var html = '';
  for (var i = 0; i < insights.length; i++) {
    var ins = insights[i];
    var detailHtml = ins.description ? '<div class="insight-detail">' + escapeHtml(ins.description) + '</div>' : '';
    var actionHtml = ins.action ? '<div class="insight-action-tip">' + escapeHtml(ins.action) + '</div>' : '';
    html += '<div class="insight-card ' + ins.type + ' animate delay-' + Math.min(i + 2, 5) + '" onclick="this.classList.toggle(\'expanded\')">' +
      '<div class="insight-top">' +
      '<div class="insight-indicator">' + (emojis[ins.type] || '') + '</div>' +
      '<div class="insight-title">' + escapeHtml(ins.title) + '</div>' +
      '<div class="insight-arrow"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M3 4.5L6 7.5L9 4.5"/></svg></div>' +
      '</div>' +
      '<div class="insight-expand">' + detailHtml + actionHtml + '</div>' +
      '</div>';
  }
  document.getElementById('insightsList').innerHTML = html;
}

// Daily chart
function renderDailyChart() {
  var canvas = document.getElementById('dailyChart');
  if (!canvas.offsetParent) return;
  var ctx = canvas.getContext('2d');
  var data = DATA.dailyUsage;
  if (!data.length) return;

  var colors = chartColors();
  var dpr = window.devicePixelRatio || 1;
  var w = canvas.parentElement.clientWidth - 48;
  var h = 200;
  canvas.width = w * dpr; canvas.height = h * dpr;
  canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
  ctx.scale(dpr, dpr);
  ctx.clearRect(0, 0, w, h);

  var maxTotal = Math.max.apply(null, data.map(function(d) { return d.totalTokens; }));
  var barW = Math.max(8, Math.min(32, (w - 52) / data.length - 3));
  var gap = 3;
  var chartH = h - 36;
  var startX = 48;

  // Grid
  ctx.font = "500 10px 'IBM Plex Sans', system-ui";
  ctx.fillStyle = colors.gridText;
  ctx.textAlign = 'right';
  for (var i = 0; i <= 4; i++) {
    var val = (maxTotal / 4) * i;
    var y = chartH - (chartH * i / 4) + 8;
    ctx.fillText(fmt(val), startX - 10, y + 3);
    ctx.strokeStyle = colors.grid; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(startX, y); ctx.lineTo(w, y); ctx.stroke();
  }

  // Bars
  var inGrad = ctx.createLinearGradient(0, chartH + 8, 0, 0);
  inGrad.addColorStop(0, colors.barIn2); inGrad.addColorStop(1, colors.barIn1);
  var outGrad = ctx.createLinearGradient(0, chartH + 8, 0, 0);
  outGrad.addColorStop(0, colors.barOut2); outGrad.addColorStop(1, colors.barOut1);

  for (var i = 0; i < data.length; i++) {
    var d = data[i];
    var x = startX + i * (barW + gap);
    var baseY = chartH + 8;
    var r = Math.min(4, barW / 2);

    var outH = (d.outputTokens / maxTotal) * chartH;
    if (outH > 0) {
      ctx.fillStyle = outGrad;
      ctx.beginPath(); roundedRect(ctx, x, baseY - outH, barW, outH, r); ctx.fill();
    }

    var inH = (d.inputTokens / maxTotal) * chartH;
    if (inH > 0) {
      ctx.fillStyle = inGrad;
      ctx.beginPath(); roundedRect(ctx, x, baseY - outH - inH, barW, inH, r); ctx.fill();
    }
  }

  // X labels
  ctx.fillStyle = colors.gridText; ctx.textAlign = 'center';
  ctx.font = "500 10px 'IBM Plex Sans', system-ui";
  var step = Math.max(1, Math.floor(data.length / 7));
  for (var i = 0; i < data.length; i++) {
    if (i % step === 0 || i === data.length - 1) {
      var x = startX + i * (barW + gap) + barW / 2;
      ctx.fillText(formatDate(data[i].date), x, chartH + 24);
    }
  }
}

function roundedRect(ctx, x, y, w, h, r) {
  if (h <= 0) return;
  r = Math.min(r, h / 2, w / 2);
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

// Model donut
function renderModelChart() {
  var canvas = document.getElementById('modelChart');
  if (!canvas.offsetParent) return;
  var ctx = canvas.getContext('2d');
  var data = DATA.modelBreakdown;
  if (!data.length) return;

  var colors = chartColors();
  var dpr = window.devicePixelRatio || 1;
  var size = Math.min(180, canvas.parentElement.clientWidth - 48);
  canvas.width = size * dpr; canvas.height = size * dpr;
  canvas.style.width = size + 'px'; canvas.style.height = size + 'px';
  ctx.scale(dpr, dpr);

  var cx = size/2, cy = size/2, r = size/2 - 6, innerR = r * 0.6;
  var total = data.reduce(function(s, d) { return s + d.totalTokens; }, 0);

  var modelClrs = { opus: ['#6366F1','#818CF8'], sonnet: ['#10B981','#34D399'], haiku: ['#F97316','#FB923C'] };
  function getColors(m) {
    var keys = Object.keys(modelClrs);
    for (var i = 0; i < keys.length; i++) { if (m.includes(keys[i])) return modelClrs[keys[i]]; }
    return ['#94A3B8','#CBD5E1'];
  }

  var angle = -Math.PI / 2;
  var slices = data.slice().sort(function(a, b) { return b.totalTokens - a.totalTokens; });

  for (var i = 0; i < slices.length; i++) {
    var d = slices[i];
    var sa = (d.totalTokens / total) * Math.PI * 2;
    var c1 = getColors(d.model)[0];

    ctx.beginPath();
    ctx.arc(cx, cy, r, angle, angle + sa);
    ctx.arc(cx, cy, innerR, angle + sa, angle, true);
    ctx.closePath();
    ctx.fillStyle = c1;
    ctx.fill();

    ctx.strokeStyle = colors.donutGap; ctx.lineWidth = 2; ctx.stroke();
    angle += sa;
  }

  ctx.fillStyle = colors.centerText; ctx.textAlign = 'center';
  ctx.font = "400 17px 'JetBrains Mono', monospace";
  ctx.fillText(fmt(total), cx, cy + 2);
  ctx.font = "500 10px 'IBM Plex Sans', system-ui";
  ctx.fillStyle = colors.centerSub;
  ctx.fillText('total', cx, cy + 16);

  var legendHtml = '';
  for (var i = 0; i < slices.length; i++) {
    var d = slices[i];
    var pct = ((d.totalTokens / total) * 100).toFixed(1);
    legendHtml += '<div class="legend-item">' +
      '<div class="legend-dot" style="background:' + getColors(d.model)[0] + '"></div>' +
      '<span><strong>' + modelShort(d.model) + '</strong> &ndash; ' + fmt(d.totalTokens) + ' (' + pct + '%)</span>' +
      '</div>';
  }
  document.getElementById('modelLegend').innerHTML = legendHtml;
}

// Project accordion
function toggleProjectDrawer(i) {
  var row = document.getElementById('proj-row-' + i);
  var drawer = document.getElementById('proj-drawer-' + i);
  var isOpen = drawer.classList.contains('open');
  row.classList.toggle('expanded', !isOpen);
  drawer.classList.toggle('open', !isOpen);
}

function buildDrawerContent(p) {
  if (!p.topPrompts || p.topPrompts.length === 0) {
    return '<div class="drawer-empty">No prompt data available</div>';
  }
  var items = [];
  for (var i = 0; i < p.topPrompts.length; i++) {
    var pr = p.topPrompts[i];
    var toolEntries = Object.entries(pr.toolCounts || {}).sort(function(a, b) { return b[1] - a[1]; });
    var chips = '';
    for (var j = 0; j < toolEntries.length; j++) {
      chips += '<span class="tool-chip">' + toolEntries[j][1] + '\u00d7\u00a0' + escapeHtml(toolEntries[j][0]) + '</span>';
    }
    if (pr.continuations > 0) chips += '<span class="tool-chip">+' + pr.continuations + ' turns</span>';
    var badge = '<span class="model-badge ' + modelClass(pr.model) + '"><span class="model-dot"></span>' + modelShort(pr.model) + '</span>';
    items.push(
      '<div class="drawer-prompt-row" onclick="openDrilldown(\'' + pr.sessionId + '\')">' +
      '<div class="drawer-rank">' + (i + 1) + '</div>' +
      '<div>' +
      '<div class="drawer-prompt-text">' + escapeHtml(pr.prompt) + '</div>' +
      '<div class="drawer-prompt-meta">' + badge + chips + '</div>' +
      '</div>' +
      '<div class="drawer-tokens"><div class="value">' + fmt(pr.totalTokens) + '</div><div class="sub">' + fmt(pr.inputTokens) + ' / ' + fmt(pr.outputTokens) + '</div></div>' +
      '</div>'
    );
  }
  return '<div class="drawer-prompt-list">' + items.join('') + '</div>';
}

// Project breakdown
function renderProjectBreakdown() {
  var projects = DATA.projectBreakdown;
  if (!projects || !projects.length) return;

  document.getElementById('projectsCount').textContent = projects.length + ' project' + (projects.length === 1 ? '' : 's');

  var maxTokens = projects[0].totalTokens;
  var chevron = '<svg class="proj-chevron" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6l4 4-4 4"/></svg>';

  // Find the most recently active project by checking session dates
  var mostRecentProject = '';
  if (DATA.sessions && DATA.sessions.length) {
    var sortedSessions = DATA.sessions.slice().sort(function(a, b) {
      return (b.timestamp || b.date || '').localeCompare(a.timestamp || a.date || '');
    });
    mostRecentProject = sortedSessions[0].project || '';
  }

  var rows = [];
  for (var i = 0; i < projects.length; i++) {
    var p = projects[i];
    var barPct = (p.totalTokens / maxTokens * 100).toFixed(1);
    var isRecentProj = p.project === mostRecentProject;
    var ariaLabel = p.modelBreakdown.map(function(m) { return modelShort(m.model) + ': ' + fmt(m.inputTokens) + ' input, ' + fmt(m.outputTokens) + ' output'; }).join(', ');
    var pillItems = '';
    for (var j = 0; j < p.modelBreakdown.length; j++) {
      var m = p.modelBreakdown[j];
      pillItems += '<li><span class="model-badge ' + modelClass(m.model) +
        '" aria-label="' + modelShort(m.model) + ': ' + fmt(m.inputTokens) + ' input, ' + fmt(m.outputTokens) + ' output">' +
        '<span class="model-dot" aria-hidden="true"></span>' +
        modelShort(m.model) +
        ' <span class="token-detail"><span aria-hidden="true">\u2193</span><span class="sr-only">in </span>' + fmt(m.inputTokens) + '</span>' +
        ' <span class="token-detail"><span aria-hidden="true">\u2191</span><span class="sr-only">out </span>' + fmt(m.outputTokens) + '</span>' +
        '</span></li>';
    }
    var recentProjTag = isRecentProj ? '<span class="recent-badge">latest</span>' : '';
    // Note: projectFull() converts filesystem-derived directory names (safe characters).
    // All values passed through escapeHtml() for XSS safety.
    rows.push(
      '<tr class="proj-row' + (isRecentProj ? ' recent-project' : '') + '" id="proj-row-' + i + '" onclick="toggleProjectDrawer(' + i + ')">' +
      '<td style="padding:10px 16px">' +
      '<div style="display:flex;align-items:center;gap:6px">' +
      chevron +
      '<div>' +
      '<div class="proj-name">' + escapeHtml(projectFull(p.project, p.projectPath)) + recentProjTag + '</div>' +
      '<ul class="model-pills" aria-label="Models used: ' + ariaLabel + '">' + pillItems + '</ul>' +
      '</div></div></td>' +
      '<td class="token-num" style="font-weight:700;vertical-align:top;padding-top:12px">' +
      '<div style="display:flex;align-items:center;gap:8px;justify-content:flex-end">' +
      '<div style="flex:1;max-width:60px;height:3px;background:var(--bg-surface);border-radius:4px;overflow:hidden">' +
      '<div style="width:' + barPct + '%;height:100%;background:var(--accent);border-radius:4px"></div>' +
      '</div><div><div>' + fmt(p.totalTokens) + '</div><div style="font-size:11px;font-weight:500;color:var(--text-tertiary);margin-top:1px">' + fmt(p.inputTokens) + ' in\u00a0\u00b7\u00a0' + fmt(p.outputTokens) + ' out</div></div></div></td>' +
      '<td class="token-num" style="vertical-align:top;padding-top:12px">' + p.sessionCount + '</td>' +
      '<td class="token-num" style="vertical-align:top;padding-top:12px">' + p.queryCount + '</td>' +
      '</tr>'
    );
    rows.push(
      '<tr class="proj-drawer" id="proj-drawer-' + i + '">' +
      '<td colspan="4"><div class="proj-drawer-inner"><div class="proj-drawer-content">' +
      buildDrawerContent(p) +
      '</div></div></td></tr>'
    );
  }
  document.getElementById('projectsBody').innerHTML = rows.join('');
}

// Top prompts
function renderTopPrompts() {
  var prompts = DATA.topPrompts;
  if (!prompts.length) return;
  var maxTokens = prompts[0].totalTokens;

  var html = '';
  for (var i = 0; i < prompts.length; i++) {
    var p = prompts[i];
    var inPct = (p.inputTokens / p.totalTokens) * 100;
    html += '<div class="prompt-row" onclick="openDrilldown(\'' + p.sessionId + '\')">' +
      '<div class="prompt-rank">' + (i + 1) + '</div>' +
      '<div>' +
      '<div class="prompt-text">' + escapeHtml(p.prompt) + '</div>' +
      '<div class="prompt-meta">' + formatDate(p.date) + ' &middot; ' + modelShort(p.model) + '</div>' +
      '<div class="token-bar-wrap" style="width:' + Math.max(10, (p.totalTokens / maxTokens) * 100) + '%">' +
      '<div class="token-bar-in" style="width:' + inPct + '%"></div>' +
      '<div class="token-bar-out" style="width:' + (100 - inPct) + '%"></div>' +
      '</div>' +
      '</div>' +
      '<div class="prompt-tokens">' +
      '<div class="value">' + fmt(p.totalTokens) + '</div>' +
      '<div class="sub">' + fmt(p.inputTokens) + ' read &middot; ' + fmt(p.outputTokens) + ' written</div>' +
      '</div>' +
      '</div>';
  }
  document.getElementById('topPromptsList').innerHTML = html;
}

// Sessions
function renderSessions() {
  var sessions = DATA.sessions.slice();
  if (searchQuery) {
    var q = searchQuery.toLowerCase();
    sessions = sessions.filter(function(s) {
      return s.firstPrompt.toLowerCase().includes(q) ||
        s.model.toLowerCase().includes(q) ||
        projectShort(s.project, s.projectPath).toLowerCase().includes(q);
    });
  }

  var sortFns = {
    date: function(a, b) { return (a.timestamp || a.date || '').localeCompare(b.timestamp || b.date || ''); },
    project: function(a, b) { return projectShort(a.project, a.projectPath).localeCompare(projectShort(b.project, b.projectPath)); },
    model: function(a, b) { return a.model.localeCompare(b.model); },
    queries: function(a, b) { return a.queryCount - b.queryCount; },
    total: function(a, b) { return a.totalTokens - b.totalTokens; },
    input: function(a, b) { return a.inputTokens - b.inputTokens; },
    output: function(a, b) { return a.outputTokens - b.outputTokens; },
  };
  var fn = sortFns[currentSort.key] || sortFns.total;
  sessions.sort(function(a, b) { return currentSort.dir === 'desc' ? fn(b, a) : fn(a, b); });

  document.getElementById('sessionCount').textContent = sessions.length + ' sessions';

  // Find 3 most recent sessions by timestamp/date
  var byDate = sessions.slice().sort(function(a, b) {
    return (b.timestamp || b.date || '').localeCompare(a.timestamp || a.date || '');
  });
  var recentIds = new Set(byDate.slice(0, 3).map(function(s) { return s.sessionId; }));

  // Note: all dynamic values are passed through escapeHtml(), fmt(), formatDate(),
  // modelShort(), modelClass(), or projectFull()/projectShort() which produce safe strings.
  // Session IDs are hex hashes from filesystem paths. No user-controlled HTML is injected.
  var html = '';
  for (var i = 0; i < sessions.length; i++) {
    var s = sessions[i];
    var isRecent = recentIds.has(s.sessionId);
    var recentClass = isRecent ? ' class="recent-session"' : '';
    var recentTag = isRecent ? '<span class="recent-badge">recent</span>' : '';
    html += '<tr' + recentClass + ' onclick="openDrilldown(\'' + s.sessionId + '\')">' +
      '<td class="date-cell">' + formatDate(s.date) + recentTag + '</td>' +
      '<td title="' + escapeHtml(projectFull(s.project, s.projectPath)) + '" style="font-weight:500">' + escapeHtml(projectShort(s.project, s.projectPath)) + '</td>' +
      '<td><span class="model-badge ' + modelClass(s.model) + '"><span class="model-dot"></span>' + modelShort(s.model) + '</span></td>' +
      '<td class="token-num">' + s.queryCount + '</td>' +
      '<td class="token-num" style="font-weight:700">' + fmt(s.totalTokens) + '</td>' +
      '<td class="token-num">' + fmt(s.inputTokens) + '</td>' +
      '<td class="token-num">' + fmt(s.outputTokens) + '</td>' +
      '</tr>';
  }
  document.getElementById('sessionsBody').innerHTML = html;
}

// Storage
function fmtBytes(b) {
  if (b >= 1073741824) return (b / 1073741824).toFixed(2) + ' GB';
  if (b >= 1048576) return (b / 1048576).toFixed(1) + ' MB';
  if (b >= 1024) return (b / 1024).toFixed(1) + ' KB';
  return b + ' B';
}

function renderStorage() {
  var storage = DATA.storage;
  var container = document.getElementById('storageContent');
  if (!storage || !storage.total) {
    container.textContent = 'No storage data available.';
    return;
  }

  // Note: all values displayed via escapeHtml() or fmtBytes() which only produce safe numeric/alpha strings.
  // No user-controlled HTML is injected. Category names come from hardcoded directory names in parser.js.
  // Project names are filesystem directory names passed through escapeHtml() for XSS safety.
  var barColors = ['var(--accent)', 'var(--teal)', 'var(--indigo)', 'var(--violet)', 'var(--emerald)', 'var(--orange)', 'var(--rose)', 'var(--blue)', 'var(--cyan)', 'var(--amber)'];
  var treemapColors = ['#D97706', '#14B8A6', '#6366F1', '#8B5CF6', '#10B981', '#F97316', '#F43F5E', '#3B82F6', '#06B6D4', '#D97706'];

  var catBars = '';
  var maxCat = storage.categories.length > 0 ? storage.categories[0].size : 1;
  for (var i = 0; i < storage.categories.length; i++) {
    var c = storage.categories[i];
    var pct = (c.size / maxCat * 100).toFixed(1);
    catBars += '<div class="storage-bar-row">' +
      '<div class="storage-bar-label">' + escapeHtml(c.name) + '/</div>' +
      '<div class="storage-bar-track"><div class="storage-bar-fill" style="width:' + pct + '%;background:' + barColors[i % barColors.length] + '"></div></div>' +
      '<div class="storage-bar-size">' + fmtBytes(c.size) + '</div></div>';
  }

  var maxProj = storage.projects.length > 0 ? storage.projects[0].size : 1;
  var projRows = '';
  for (var i = 0; i < Math.min(storage.projects.length, 15); i++) {
    var p = storage.projects[i];
    var pct = (p.size / maxProj * 100).toFixed(1);
    projRows += '<div class="storage-bar-row">' +
      '<div class="storage-bar-label" title="' + escapeHtml(p.name) + '">' + escapeHtml(projectShort(p.name)) + '</div>' +
      '<div class="storage-bar-track"><div class="storage-bar-fill" style="width:' + pct + '%;background:' + barColors[i % barColors.length] + '"></div></div>' +
      '<div class="storage-bar-size">' + fmtBytes(p.size) + '</div></div>';
  }

  var treeCells = '';
  var totalForTree = storage.categories.reduce(function(s, c) { return s + c.size; }, 0) || 1;
  for (var i = 0; i < storage.categories.length; i++) {
    var c = storage.categories[i];
    var cols = (c.size / totalForTree) > 0.3 ? 2 : 1;
    treeCells += '<div class="treemap-cell" style="background:' + treemapColors[i % treemapColors.length] + ';grid-column:span ' + cols + '">' +
      '<div class="tm-name">' + escapeHtml(c.name) + '/</div>' +
      '<div class="tm-size">' + fmtBytes(c.size) + ' &middot; ' + c.fileCount + ' files</div></div>';
  }

  // External locations section
  // Note: external location names come from hardcoded strings in parser.js, passed through escapeHtml() for safety.
  // All size values use fmtBytes() which only produces safe numeric strings.
  var extHtml = '';
  var extLocs = storage.externalLocations || [];
  var extTotal = extLocs.reduce(function(s, e) { return s + e.size; }, 0);
  if (extLocs.length > 0) {
    var extRows = '';
    for (var i = 0; i < extLocs.length; i++) {
      var e = extLocs[i];
      var extPct = (e.size / Math.max(extLocs[0].size, 1) * 100).toFixed(1);
      extRows += '<div class="storage-bar-row">' +
        '<div class="storage-bar-label">' + escapeHtml(e.name) + '</div>' +
        '<div class="storage-bar-track"><div class="storage-bar-fill" style="width:' + extPct + '%;background:var(--rose)"></div></div>' +
        '<div class="storage-bar-size">' + fmtBytes(e.size) + '</div></div>';
    }
    extHtml = '<div class="storage-bar-card" style="margin-bottom:28px"><h3>External Storage (Desktop App)</h3>' + extRows + '</div>';
  }

  // Headline: show total footprint, with subtitle breaking down CLI vs external
  var cliTotal = storage.cliTotal || storage.total;
  var subtitleParts = [fmtBytes(cliTotal) + ' CLI data'];
  if (extTotal > 0) subtitleParts.push(fmtBytes(extTotal) + ' Desktop app');
  var subtitleText = subtitleParts.join(' + ');

  // Build and set  all dynamic values are either escaped strings or numeric formatters.
  // Category/project names from filesystem are passed through escapeHtml() for XSS safety.
  var html =
    '<div class="storage-headline">' + fmtBytes(storage.total) + '</div>' +
    '<div class="storage-sub">Total Claude Code footprint &mdash; ' + subtitleText + '</div>' +
    extHtml +
    '<div class="storage-treemap" style="grid-template-columns:repeat(3,1fr)">' + treeCells + '</div>' +
    '<div class="storage-grid">' +
    '<div class="storage-bar-card"><h3>~/.claude By Directory</h3>' + catBars + '</div>' +
    '<div class="storage-bar-card"><h3>~/.claude By Project</h3>' + (projRows || '<div class="drawer-empty">No project data</div>') + '</div>' +
    '</div>';
  container.innerHTML = html;
}

// Sort
document.querySelectorAll('.sessions-table th[data-sort]').forEach(function(th) {
  th.addEventListener('click', function() {
    var key = th.dataset.sort;
    if (currentSort.key === key) { currentSort.dir = currentSort.dir === 'desc' ? 'asc' : 'desc'; }
    else { currentSort = { key: key, dir: 'desc' }; }
    document.querySelectorAll('.sessions-table th').forEach(function(t) { t.classList.remove('sorted'); });
    th.classList.add('sorted');
    renderSessions();
  });
});

document.getElementById('searchInput').addEventListener('input', function(e) {
  searchQuery = e.target.value;
  renderSessions();
});

// Drill-down modal
function openDrilldown(sessionId) {
  var session = DATA.sessions.find(function(s) { return s.sessionId === sessionId; });
  if (!session) return;

  document.getElementById('drilldownTitle').textContent = session.firstPrompt.substring(0, 140);
  document.getElementById('drilldownMeta').textContent =
    formatDate(session.date) + ' \u00B7 ' + modelShort(session.model) + ' \u00B7 ' + session.queryCount + ' messages \u00B7 ' + fmt(session.totalTokens) + ' tokens';

  var grouped = [];
  var current = null;
  for (var i = 0; i < session.queries.length; i++) {
    var q = session.queries[i];
    if (q.userPrompt) {
      if (current) grouped.push(current);
      current = { prompt: q.userPrompt, inputTokens: q.inputTokens, outputTokens: q.outputTokens, totalTokens: q.totalTokens, continuations: 0 };
    } else if (current) {
      current.inputTokens += q.inputTokens;
      current.outputTokens += q.outputTokens;
      current.totalTokens += q.totalTokens;
      current.continuations++;
    }
  }
  if (current) grouped.push(current);

  var html = '';
  for (var i = 0; i < grouped.length; i++) {
    var q = grouped[i];
    var cont = q.continuations > 0 ? ' + ' + q.continuations + ' tool uses' : '';
    html += '<div class="query-item">' +
      '<div class="query-num">' + (i + 1) + '</div>' +
      '<div class="query-prompt">' + escapeHtml(q.prompt.substring(0, 500)) + '</div>' +
      '<div class="query-tokens-col">' +
      '<div class="total">' + fmt(q.totalTokens) + '</div>' +
      '<div class="detail">' + fmt(q.inputTokens) + ' read / ' + fmt(q.outputTokens) + ' written' + cont + '</div>' +
      '</div></div>';
  }
  document.getElementById('queryList').innerHTML = html;

  document.getElementById('drilldownOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeDrilldown() {
  document.getElementById('drilldownOverlay').classList.remove('open');
  document.body.style.overflow = '';
}

// Close drilldown on Escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeDrilldown();
});

fetchData();
window.addEventListener('resize', function() {
  if (DATA) {
    if (currentTab === 'overview') { renderDailyChart(); renderModelChart(); }
    updateTabIndicator();
  }
});
</script>
</body>
</html>
